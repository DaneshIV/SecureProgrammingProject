<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Connection Tester</title>
  <script src="config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      color: #333;
    }
    
    .test-group {
      margin-bottom: 30px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    
    .test-group h3 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    
    .test-button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .test-button:hover {
      background-color: #45a049;
    }
    
    .result {
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }
    
    .success {
      background-color: #d4edda;
      border-color: #c3e6cb;
    }
    
    .error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .config-info {
      background-color: #e2f0ff;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .nav-buttons {
      margin-top: 20px;
      text-align: center;
    }
    
    .nav-button {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 10px;
    }
    
    .diagnostic-section {
      border-top: 1px solid #ddd;
      margin-top: 20px;
      padding-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>API Connection Tester</h1>
    
    <div class="config-info">
      <h3>Current Configuration</h3>
      <div id="config-display"></div>
    </div>
    
    <div class="test-group">
      <h3>CORS Test</h3>
      <p>Tests if the CORS configuration is working properly.</p>
      <button class="test-button" onclick="testCORS()">Test CORS Configuration</button>
      <div id="cors-result" class="result">Results will appear here</div>
    </div>
    
    <div class="test-group">
      <h3>Payment History API Test</h3>
      <div class="form-group">
        <label for="email-input">Email Address:</label>
        <input type="email" id="email-input" value="test@example.com">
      </div>
      <button class="test-button" onclick="testPaymentHistory()">Test Payment History API</button>
      <button class="test-button" onclick="testPaymentHistoryDirect()">Test Direct API Call (No CORS)</button>
      <div id="payment-result" class="result">Results will appear here</div>
    </div>
    
    <div class="test-group">
      <h3>Network Test</h3>
      <p>Tests overall network connectivity.</p>
      <button class="test-button" onclick="testNetwork()">Test Network Connectivity</button>
      <div id="network-result" class="result">Results will appear here</div>
    </div>
    
    <div class="test-group">
      <h3>Config Override</h3>
      <div class="form-group">
        <label for="api-url-input">API URL:</label>
        <input type="text" id="api-url-input" placeholder="Enter API URL (e.g., https://83bc16e00594.ngrok-free.app)">
      </div>
      <button class="test-button" onclick="updateConfig()">Update Configuration</button>
      <div id="config-result" class="result">Enter a URL and click update</div>
    </div>
    
    <div class="diagnostic-section">
      <h3>Troubleshooting Information</h3>
      <p>If you're experiencing issues, the following information may help:</p>
      <ul>
        <li>Ensure your ngrok tunnel is running and accessible</li>
        <li>Check that CORS is properly configured on the server</li>
        <li>Verify that your browser isn't blocking third-party cookies</li>
        <li>Ensure the API URL in config.js matches your ngrok URL</li>
      </ul>
      <div id="browser-info" class="result">Browser information will appear here</div>
      <button class="test-button" onclick="collectBrowserInfo()">Collect Browser Info</button>
    </div>
    
    <div class="nav-buttons">
      <button class="nav-button" onclick="window.location.href='index.html'">Home</button>
      <button class="nav-button" onclick="window.location.href='history.html'">Payment History</button>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Display current config
      displayConfig();
      
      // Try to set a demo user in localStorage if not already set
      try {
        if (!localStorage.getItem('auth')) {
          localStorage.setItem('auth', JSON.stringify({ email: 'test@example.com' }));
          console.log('Set demo user in localStorage');
        }
      } catch (e) {
        console.error('Could not set localStorage:', e);
      }
    });
    
    function displayConfig() {
      const configDisplay = document.getElementById('config-display');
      const config = window.APP_CONFIG || { API_URL: 'Not set', ENVIRONMENT: 'Not set' };
      
      configDisplay.innerHTML = `
        <strong>API URL:</strong> ${config.API_URL || 'Not set (using relative URLs)'}<br>
        <strong>Environment:</strong> ${config.ENVIRONMENT || 'Not set'}<br>
        <strong>Current URL:</strong> ${window.location.href}<br>
        <strong>Origin:</strong> ${window.location.origin}
      `;
    }
    
    async function testCORS() {
      const resultDiv = document.getElementById('cors-result');
      resultDiv.className = 'result';
      resultDiv.innerHTML = 'Testing CORS configuration...';
      
      try {
        const apiUrl = window.APP_CONFIG?.API_URL || '';
        const corsTestUrl = `${apiUrl}/api/cors-test`;
        
        resultDiv.innerHTML += `\nFetching: ${corsTestUrl}`;
        
        const response = await fetch(corsTestUrl, {
          mode: 'cors',
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Origin': window.location.origin
          }
        });
        
        const contentType = response.headers.get('content-type');
        resultDiv.innerHTML += `\nStatus: ${response.status}`;
        resultDiv.innerHTML += `\nContent-Type: ${contentType}`;
        
        const text = await response.text();
        resultDiv.innerHTML += `\nResponse preview: ${text.substring(0, 100)}`;
        
        if (response.ok) {
          try {
            const data = JSON.parse(text);
            resultDiv.className = 'result success';
            resultDiv.innerHTML += `\n\nCORS test successful!\n${JSON.stringify(data, null, 2)}`;
          } catch (e) {
            resultDiv.className = 'result error';
            resultDiv.innerHTML += `\n\nError parsing JSON: ${e.message}`;
          }
        } else {
          resultDiv.className = 'result error';
          resultDiv.innerHTML += `\n\nCORS test failed with status: ${response.status}`;
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `Error testing CORS: ${error.message}`;
      }
    }
    
    async function testPaymentHistory() {
      const resultDiv = document.getElementById('payment-result');
      const emailInput = document.getElementById('email-input');
      const email = emailInput.value || 'test@example.com';
      
      resultDiv.className = 'result';
      resultDiv.innerHTML = `Testing payment history API with email: ${email}...`;
      
      try {
        const apiUrl = window.APP_CONFIG?.API_URL || '';
        const fullUrl = `${apiUrl}/api/payment-history?email=${email}`;
        
        resultDiv.innerHTML += `\nFetching: ${fullUrl}`;
        
        const response = await fetch(fullUrl, {
          mode: 'cors',
          credentials: 'include',
          headers: {
            'Accept': 'application/json',
            'Origin': window.location.origin
          }
        });
        
        const contentType = response.headers.get('content-type');
        resultDiv.innerHTML += `\nStatus: ${response.status}`;
        resultDiv.innerHTML += `\nContent-Type: ${contentType}`;
        
        const text = await response.text();
        resultDiv.innerHTML += `\nResponse preview: ${text.substring(0, 100)}...`;
        
        if (response.ok) {
          try {
            const data = JSON.parse(text);
            resultDiv.className = 'result success';
            resultDiv.innerHTML += `\n\nPayment history API test successful!\nFound ${data.length} payment records.`;
          } catch (e) {
            resultDiv.className = 'result error';
            resultDiv.innerHTML += `\n\nError parsing JSON: ${e.message}`;
          }
        } else {
          resultDiv.className = 'result error';
          resultDiv.innerHTML += `\n\nPayment history API test failed with status: ${response.status}`;
        }
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `Error testing payment history API: ${error.message}`;
      }
    }
    
    function testPaymentHistoryDirect() {
      const resultDiv = document.getElementById('payment-result');
      const emailInput = document.getElementById('email-input');
      const email = emailInput.value || 'test@example.com';
      
      resultDiv.className = 'result';
      resultDiv.innerHTML = `Testing direct API call (bypassing CORS) with email: ${email}...`;
      
      const apiUrl = window.APP_CONFIG?.API_URL || '';
      if (!apiUrl) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = 'Cannot test direct API call: No API URL configured';
        return;
      }
      
      const fullUrl = `${apiUrl}/api/payment-history?email=${email}`;
      resultDiv.innerHTML += `\nAPI URL: ${fullUrl}`;
      
      // Create an iframe to make a request that bypasses CORS
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      
      // Create a script element in the iframe to make the request
      try {
        const script = document.createElement('script');
        script.innerHTML = `
          // Make a simple JSONP-style request by creating a script element
          const script = document.createElement('script');
          script.src = "${fullUrl}&callback=processResponse";
          
          // Define a global callback function
          window.processResponse = function(data) {
            window.parent.postMessage({
              type: 'api-response',
              success: true,
              data: data
            }, '*');
          };
          
          // Handle errors
          script.onerror = function() {
            window.parent.postMessage({
              type: 'api-response',
              success: false,
              error: 'Failed to load API endpoint'
            }, '*');
          };
          
          document.body.appendChild(script);
          
          // If there's no response within 5 seconds, assume failure
          setTimeout(function() {
            window.parent.postMessage({
              type: 'api-response',
              success: false,
              error: 'Timeout waiting for API response'
            }, '*');
          }, 5000);
        `;
        
        iframe.contentDocument.body.appendChild(script);
        
        // Listen for the response
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'api-response') {
            if (event.data.success) {
              resultDiv.className = 'result success';
              resultDiv.innerHTML += `\n\nDirect API call successful!`;
              if (event.data.data) {
                resultDiv.innerHTML += `\nFound ${event.data.data.length} payment records.`;
              }
            } else {
              resultDiv.className = 'result error';
              resultDiv.innerHTML += `\n\nDirect API call failed: ${event.data.error}`;
            }
            
            // Clean up
            document.body.removeChild(iframe);
          }
        });
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `Error with direct API test: ${error.message}`;
      }
    }
    
    async function testNetwork() {
      const resultDiv = document.getElementById('network-result');
      resultDiv.className = 'result';
      resultDiv.innerHTML = 'Testing network connectivity...';
      
      try {
        const apiUrl = window.APP_CONFIG?.API_URL || '';
        
        resultDiv.innerHTML += `\nTesting connectivity to API URL: ${apiUrl || 'Not configured'}`;
        
        // Test 1: Basic connectivity
        try {
          const response = await fetch('https://www.google.com', { mode: 'no-cors' });
          resultDiv.innerHTML += `\n✓ Basic internet connectivity is working`;
        } catch (e) {
          resultDiv.innerHTML += `\n❌ Basic internet connectivity failed: ${e.message}`;
        }
        
        // Test 2: API server connectivity
        if (apiUrl) {
          try {
            const startTime = performance.now();
            await fetch(`${apiUrl}/api/cors-test`, { mode: 'no-cors' });
            const endTime = performance.now();
            resultDiv.innerHTML += `\n✓ API server connectivity is working (${Math.round(endTime - startTime)}ms)`;
          } catch (e) {
            resultDiv.innerHTML += `\n❌ API server connectivity failed: ${e.message}`;
          }
        } else {
          resultDiv.innerHTML += `\n⚠️ Cannot test API server connectivity: No API URL configured`;
        }
        
        // Test 3: DNS resolution
        if (apiUrl) {
          try {
            const hostname = new URL(apiUrl).hostname;
            resultDiv.innerHTML += `\nChecking DNS for ${hostname}...`;
            
            const dnsCheckUrl = `https://dns.google/resolve?name=${hostname}`;
            const dnsResponse = await fetch(dnsCheckUrl);
            const dnsData = await dnsResponse.json();
            
            if (dnsData.Answer) {
              resultDiv.innerHTML += `\n✓ DNS resolution successful: ${hostname} resolves to ${dnsData.Answer[0].data}`;
            } else {
              resultDiv.innerHTML += `\n❌ DNS resolution failed for ${hostname}`;
            }
          } catch (e) {
            resultDiv.innerHTML += `\n⚠️ Could not perform DNS check: ${e.message}`;
          }
        }
        
        resultDiv.className = 'result success';
        resultDiv.innerHTML += '\n\nNetwork tests completed.';
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `Error testing network: ${error.message}`;
      }
    }
    
    function updateConfig() {
      const resultDiv = document.getElementById('config-result');
      const apiUrlInput = document.getElementById('api-url-input');
      const newApiUrl = apiUrlInput.value.trim();
      
      if (!newApiUrl) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = 'Please enter an API URL';
        return;
      }
      
      try {
        // Just update in-memory config for this session
        if (!window.APP_CONFIG) {
          window.APP_CONFIG = {};
        }
        
        window.APP_CONFIG.API_URL = newApiUrl;
        window.APP_CONFIG.ENVIRONMENT = 'custom';
        
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `Configuration updated for this session:\nAPI URL: ${newApiUrl}\nEnvironment: custom`;
        
        // Update the config display
        displayConfig();
      } catch (error) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `Error updating configuration: ${error.message}`;
      }
    }
    
    function collectBrowserInfo() {
      const infoDiv = document.getElementById('browser-info');
      
      try {
        const info = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          cookiesEnabled: navigator.cookieEnabled,
          localStorage: !!window.localStorage,
          sessionStorage: !!window.sessionStorage,
          online: navigator.onLine,
          screenSize: {
            width: window.screen.width,
            height: window.screen.height
          },
          windowSize: {
            width: window.innerWidth,
            height: window.innerHeight
          }
        };
        
        infoDiv.innerHTML = JSON.stringify(info, null, 2);
      } catch (error) {
        infoDiv.className = 'result error';
        infoDiv.innerHTML = `Error collecting browser info: ${error.message}`;
      }
    }
  </script>
</body>
</html>
