<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentication Test Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #333;
    }
    .test-group {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-results {
      margin-top: 10px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    input, select {
      padding: 8px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .success {
      color: #4CAF50;
    }
    .error {
      color: #f44336;
    }
    .warning {
      color: #ff9800;
    }
    .code {
      font-family: monospace;
      background-color: #f1f1f1;
      padding: 2px 4px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Authentication & API Connectivity Test Tool</h1>
    <p>This tool helps you verify that authentication and API connectivity are working correctly in your Vercel deployment.</p>
    
    <div class="test-group">
      <h2>1. Test API Connectivity</h2>
      <p>Test the connection to the ngrok API and the Vercel proxy:</p>
      <button onclick="testNgrokDirect()">Test Direct Ngrok</button>
      <button onclick="testVercelProxy()">Test Vercel Proxy</button>
      <div id="api-test-results" class="test-results"></div>
    </div>
    
    <div class="test-group">
      <h2>2. Authentication Tests</h2>
      <p>Test storing and retrieving authentication data:</p>
      <button onclick="setDemoAuth('user@example.com')">Set Demo Auth (user@example.com)</button>
      <button onclick="setDemoAuth('test@example.com')">Set Demo Auth (test@example.com)</button>
      <button onclick="clearAllAuth()">Clear All Auth</button>
      <button onclick="checkAllAuth()">Check Auth Status</button>
      <div id="auth-test-results" class="test-results"></div>
    </div>
    
    <div class="test-group">
      <h2>3. Test Payment History API</h2>
      <input type="text" id="email-input" placeholder="Enter email (e.g., test@example.com)">
      <button onclick="testPaymentHistory()">Test Payment History API</button>
      <div id="payment-test-results" class="test-results"></div>
    </div>
    
    <div class="test-group">
      <h2>4. Open History Page</h2>
      <p>Open the history page in a new tab and test the authentication flow:</p>
      <select id="environment-select">
        <option value="local">Local (http://localhost:3000/history.html)</option>
        <option value="vercel" selected>Vercel (https://secureprogrammingproject.vercel.app/history.html)</option>
      </select>
      <button onclick="openHistoryPage()">Open History Page</button>
      <p>Steps to test:</p>
      <ol>
        <li>When the page opens, click one of the demo login buttons</li>
        <li>Verify that your payment history loads</li>
        <li>Click "Show Debug Info" to see authentication details</li>
      </ol>
    </div>
    
    <div class="test-group">
      <h2>5. Browser Storage Status</h2>
      <p>Current authentication data in browser storage:</p>
      <button onclick="updateStorageDisplay()">Refresh Storage Data</button>
      <div id="storage-display" class="test-results"></div>
    </div>
  </div>
  
  <script>
    // Configuration
    const NGROK_URL = 'https://83bc16e00594.ngrok-free.app';
    const VERCEL_URL = 'https://secureprogrammingproject.vercel.app';
    
    // Helper function to log results
    function logResult(elementId, message, type = 'normal') {
      const resultsDiv = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      resultsDiv.innerHTML = `<div class="${type}">[${timestamp}] ${message}</div>` + resultsDiv.innerHTML;
    }
    
    // Test direct connection to ngrok
    async function testNgrokDirect() {
      logResult('api-test-results', `Testing direct connection to ${NGROK_URL}/api/cors-test...`);
      try {
        const response = await fetch(`${NGROK_URL}/api/cors-test`, {
          mode: 'cors',
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          logResult('api-test-results', `✓ Ngrok direct connection successful! Response: ${JSON.stringify(data)}`, 'success');
        } else {
          logResult('api-test-results', `✗ Ngrok direct connection failed with status: ${response.status}`, 'error');
        }
      } catch (error) {
        logResult('api-test-results', `✗ Ngrok direct connection error: ${error.message}`, 'error');
      }
    }
    
    // Test Vercel proxy
    async function testVercelProxy() {
      logResult('api-test-results', `Testing Vercel proxy connection to ${VERCEL_URL}/api/cors-test...`);
      try {
        const response = await fetch(`${VERCEL_URL}/api/cors-test`, {
          mode: 'cors',
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          logResult('api-test-results', `✓ Vercel proxy connection successful! Response: ${JSON.stringify(data)}`, 'success');
        } else {
          logResult('api-test-results', `✗ Vercel proxy connection failed with status: ${response.status}`, 'error');
        }
      } catch (error) {
        logResult('api-test-results', `✗ Vercel proxy connection error: ${error.message}`, 'error');
      }
    }
    
    // Set demo authentication
    function setDemoAuth(email) {
      try {
        // Store in localStorage
        const demoAuth = { email: email };
        localStorage.setItem('auth', JSON.stringify(demoAuth));
        localStorage.setItem('user_email', email);
        
        // Store in sessionStorage
        sessionStorage.setItem('auth', JSON.stringify(demoAuth));
        
        // Set a cookie
        document.cookie = `user_email=${email}; path=/; max-age=86400`;
        
        logResult('auth-test-results', `✓ Set authentication for ${email} in all storage mechanisms`, 'success');
        updateStorageDisplay();
      } catch (error) {
        logResult('auth-test-results', `✗ Error setting authentication: ${error.message}`, 'error');
      }
    }
    
    // Clear all authentication data
    function clearAllAuth() {
      try {
        localStorage.removeItem('auth');
        localStorage.removeItem('user_email');
        sessionStorage.removeItem('auth');
        document.cookie = "user_email=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
        
        logResult('auth-test-results', `✓ Cleared all authentication data`, 'success');
        updateStorageDisplay();
      } catch (error) {
        logResult('auth-test-results', `✗ Error clearing authentication: ${error.message}`, 'error');
      }
    }
    
    // Check authentication status
    function checkAllAuth() {
      try {
        let authMethods = [];
        
        // Check localStorage
        const localAuth = localStorage.getItem('auth');
        const localEmail = localStorage.getItem('user_email');
        if (localAuth) authMethods.push(`localStorage.auth: ${localAuth}`);
        if (localEmail) authMethods.push(`localStorage.user_email: ${localEmail}`);
        
        // Check sessionStorage
        const sessionAuth = sessionStorage.getItem('auth');
        if (sessionAuth) authMethods.push(`sessionStorage.auth: ${sessionAuth}`);
        
        // Check cookies
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'user_email') {
            authMethods.push(`cookie.user_email: ${value}`);
          }
        }
        
        if (authMethods.length > 0) {
          logResult('auth-test-results', `✓ Found authentication in: ${authMethods.join(', ')}`, 'success');
        } else {
          logResult('auth-test-results', `✗ No authentication found in any storage mechanism`, 'warning');
        }
      } catch (error) {
        logResult('auth-test-results', `✗ Error checking authentication: ${error.message}`, 'error');
      }
    }
    
    // Test payment history API
    async function testPaymentHistory() {
      const email = document.getElementById('email-input').value || 'test@example.com';
      logResult('payment-test-results', `Testing payment history API for ${email}...`);
      
      try {
        // Try direct ngrok first
        const response = await fetch(`${NGROK_URL}/api/payment-history?email=${email}`, {
          mode: 'cors',
          credentials: 'include',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          logResult('payment-test-results', `✓ Found ${data.length} payment records for ${email}`, 'success');
          logResult('payment-test-results', `First payment: ${JSON.stringify(data[0])}`, 'success');
        } else {
          logResult('payment-test-results', `✗ API request failed with status: ${response.status}`, 'error');
        }
      } catch (error) {
        logResult('payment-test-results', `✗ Error accessing payment history API: ${error.message}`, 'error');
      }
    }
    
    // Open history page in a new tab
    function openHistoryPage() {
      const environment = document.getElementById('environment-select').value;
      let url;
      
      if (environment === 'local') {
        url = 'http://localhost:3000/history.html';
      } else {
        url = 'https://secureprogrammingproject.vercel.app/history.html';
      }
      
      window.open(url, '_blank');
    }
    
    // Update storage display
    function updateStorageDisplay() {
      const storageDiv = document.getElementById('storage-display');
      storageDiv.innerHTML = '';
      
      // LocalStorage
      storageDiv.innerHTML += '<strong>localStorage:</strong><br>';
      if (localStorage.length === 0) {
        storageDiv.innerHTML += '- Empty<br>';
      } else {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          storageDiv.innerHTML += `- ${key}: ${localStorage.getItem(key)}<br>`;
        }
      }
      
      // SessionStorage
      storageDiv.innerHTML += '<br><strong>sessionStorage:</strong><br>';
      if (sessionStorage.length === 0) {
        storageDiv.innerHTML += '- Empty<br>';
      } else {
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          storageDiv.innerHTML += `- ${key}: ${sessionStorage.getItem(key)}<br>`;
        }
      }
      
      // Cookies
      storageDiv.innerHTML += '<br><strong>cookies:</strong><br>';
      if (document.cookie === '') {
        storageDiv.innerHTML += '- No cookies<br>';
      } else {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
          storageDiv.innerHTML += `- ${cookie.trim()}<br>`;
        }
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateStorageDisplay();
    });
  </script>
</body>
</html>
